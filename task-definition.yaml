version: 1
task_definition:
  services:
    backend:
      essential: true
      restart: "on-failure"
      image: interactify:latest
      depends_on:
        - containerName: backend-db
        - containerName: backend-cache
      env_file:
        - dev.env
      port_mappings:
        - container_port: 80
          host_port: 80
      environment:
        - name: MYSQL_DB_NAME
          value: ${DB}
        - name: DJANGO_SETTINGS_MODULE
          value: interactify.settings
      mount_points:
        - source_volume: gunicorn
          container_path: /etc/gunicorn
          read_only: false
    backend-db:
      essential: true
      restart: "always"
      image: mysql:latest
      environment:
        - name: MYSQL_ALLOW_EMPTY_PASSWORD
          value: "1"
        - name: MYSQL_DATABASE
          value: ${DB}
      mount_points:
        - source_volume: mysql-data
          container_path: /var/lib/mysql
          read_only: false
      health_check:
        command:
          - CMD
          - "mysqladmin"
          - "ping"
          - "-h"
          - "localhost"
        interval: 30
        timeout: 20
        retries: 10
    backend-cache:
      essential: true
      image: redis:latest
    backend-server:
      essential: true
      image: nginx:latest
      mount_points:
        - source_volume: nginx
          container_path: /etc/nginx/conf.d
          read_only: false
      port_mappings:
        - container_port: 80
          host_port: 80
      depends_on:
        - containerName: backend
    backend-ci-cd:
      essential: true
      image: jenkins/jenkins:lts
      environment:
        - name: JENKINS_OPTS
          value: "--httpPort=8080"
      port_mappings:
        - container_port: 8080
          host_port: 8080
      depends_on:
        - containerName: backend
